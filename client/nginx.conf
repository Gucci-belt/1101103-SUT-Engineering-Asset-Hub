server {
    listen 80;
    server_name gucci-belt.me www.gucci-belt.me;

    # Rate Limiting Zone definition should be in http block usually, 
    # but here we can try to apply headers first. 
    # (Note: limit_req_zone must be in http block, if this file is included in http block it's fine.
    #  If this file IS the full config, we might need to adjust. Assuming this is included in conf.d)
    
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name gucci-belt.me www.gucci-belt.me;

    ssl_certificate /etc/letsencrypt/live/gucci-belt.me/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gucci-belt.me/privkey.pem;
    
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # --- Security Headers (Added to fix ZAP Alerts) ---
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval'; worker-src 'self' blob:; img-src 'self' data: https: blob:;" always;
    # --------------------------------------------------

    # --- Performance Optimization (Lighthouse) ---
    gzip on;
    gzip_comp_level 6;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_vary on;
    gzip_types application/javascript application/json application/xml text/css text/plain text/javascript text/xml image/svg+xml;

    # Cache static assets but EXCLUDE /uploads/ (which needs to hit proxy)
    location ~* ^/(?!uploads/).*\.(?:css|js|jpg|jpeg|gif|png|ico|svg|webp|woff|woff2|ttf|eot)$ {
        root /usr/share/nginx/html;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }
    # ---------------------------------------------

    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }

    location /api/ {
        proxy_pass http://it-assets-server:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Serve uploaded images
    location /uploads/ {
        proxy_pass http://it-assets-server:3000/uploads/;
    }
}
